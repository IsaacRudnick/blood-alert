# Blood Alert

This application is designed with the goal of offering diabetics the option of having an emergency contact (EC) alerted when the diabetic's blood sugar is out of range (OOR), but without needing constant false-positives (i.e. OOR but diabetic is aware and fine, and so alerting emergency contact is unneeded) by first checking with the diabetic and, only in the instance that they don't respond, alerting the EC.

## Codebase Overview

- See [Command-Line Interaction](#command-line-interaction) for more information on the commands provided by the program
- See [Logging](#logging) for more information on the logs generated by the program
- See [File structure](#file-structure) for more information on the files in the program

to understand what the program is doing, begin by looking at [app.ts](src/app.ts). This is the entry point for the program. It sets up the server and the database, and then starts the checker functionality. The checker functionality is defined in [checker.ts](src/checker/checker.ts) and is called once to start it. The checker functionality is responsible for checking the users' blood sugars and alerting the EC if necessary.

To understand how the program works, you will need a decent understanding of

- [Node.js](https://nodejs.org/api/synopsis.html) - the JavaScript runtime used which allows JavaScript to be run outside of a browser
  - with [Express.js](https://expressjs.com/) - the web framework used
- [MongoDB](https://www.mongodb.com/basics) - the database used (understanding [JSON](https://www.w3schools.com/js/js_json_intro.asp) will help with understanding MongoDB)
- [RESTful API](https://restfulapi.net/) servers in general - knowing what a web request is, what a web response is, and how they are structured will help with understanding the program. This [article](https://www.freecodecamp.org/news/what-is-an-api-in-english-please-b880a3214a82/) is a good introduction to APIs and web requests/responses.

## Command-Line Interaction

The commands for the program are defined in the [package.json](package.json) file.
Here is an overview of the provided commands. Run a command with `npm run <command>`:

- `dev`: run the program and restart it when files are changed using [nodemon](https://www.npmjs.com/package/nodemon)
- `build`: build the program using [tsc](https://www.npmjs.com/package/typescript) and copy the necessary files to the `dist/` folder
- `start`: run the program. Requires the program to be built first
- `clean`: delete the `dist/` and `logs/` folders entirely
- `copy-files`: copy the necessary files to the `dist/` folder. This is a utility command used by `build`

## Logging

There are three levels of logging:

- debug
- info
- error

The `logs/` directory has subdirectories for each level of logging. Each subdirectory has a file for each day with logs.
Every log file has the logs at its level and above. Thus, only errors will be seen in error logs, but everything will be seen in debug logs.
Logging can be configured in [the logger util](src/util/logger.ts).

## File structure

Some files are not included here to avoid cluttering the diagram. These files are either: \
not important to the understanding of the program, self-explanatory, or automatically generated by the program.
For example, `views/404.ejs` does not need to be explicitly stated to be the 404 page.

> [src](src/) - code for the application
> │ [app.ts](src/app.ts) - entry point for the program
> │
> ├───[@types](src/@types/) - typescript type definitions
> │  
> ├───[checker](src/checker/) - the continual user-checking functionality of the program
> │ checker.ts - the main file for the checker functionality
> │
> ├───[controllers](src/controllers/) - the controllers for the web requests
> │ controller.ts - handles the logic for the web requests
> │ sms_controller.ts - handles sms webhook requests (when user responds, this controller handles the webhook from Twilio)
> │
> ├───[routes](src/routes/)
> │ routes.ts - the routes for user web requests
> │ sms_routes.ts - the routes for the sms webhook requests
> │
> ├───[models](src/models/) - the models for the DB
> │ case.ts - the model for a case (a case is a user's OOR blood sugar) in the DB
> │ user.ts - the model for a user in the DB
> │
> ├───[util](src/util/) - utility files
> │ logger.ts - a logger for the program. See more in [Logging](#logging)
> │ secrets.ts - handles the secrets for the program (e.g. Twilio API keys) by pulling them from the .env file and making them available to the program. Ensures appropriate secrets are available before the program starts and throws an error if they are not.

> [views](views/) - the views for the web requests through [EJS](https://ejs.co/)
> │ 404.ejs - the 404 page
> │ index.ejs - the home page
> │ profile.ejs - the profile page
> │ template.ejs - the template for the other pages
> │
> ├───[partials](views/partials/) - Article on [EJS partials](https://medium.com/@henslejoseph/ejs-partials-f6f102cb7433)
> │ footer.ejs - the footer for the pages
> │ GoogleSignInSetup.ejs - Imports the Google sign-in script and sets up the sign-in button
> │ header.ejs - the header for the pages
> │  
> ├───[public](views/public/) - the public files for the web requests (images, css, js, etc.)
> │ consoleWarn.js - a script that warns the user not to paste anything into the console (to prevent JWT theft)
> │ NightscoutURLutils.js - a script that handles the Nightscout URL input on the profile page
> │ styles.css - the css for the pages
